/*
 Dimension by HTML5 UP
 html5up.net | @ajlkn
 Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
*/

(function ($) {
  var $window = $(window),
    $body = $("body"),
    $wrapper = $("#wrapper"),
    $header = $("#header"),
    $footer = $("#footer"),
    $main = $("#main"),
    $main_articles = $main.children("article");

  breakpoints({
    xlarge: ["1281px", "1680px"],
    large: ["981px", "1280px"],
    medium: ["737px", "980px"],
    small: ["481px", "736px"],
    xsmall: ["361px", "480px"],
    xxsmall: [null, "360px"],
  });

  $window.on("load", function () {
    window.setTimeout(function () {
      $body.removeClass("is-preload");
      // Breadcrumbs fade-in after intro
      var $bc = $(".breadcrumbs");
      if ($bc.length) {
        setTimeout(function(){ $bc.css("opacity",1); }, 600);
      }
    }, 100);
  });

  if (browser.name == "ie") {
    var flexboxFixTimeoutId;

    $window
      .on("resize.flexbox-fix", function () {
        clearTimeout(flexboxFixTimeoutId);

        flexboxFixTimeoutId = setTimeout(function () {
          if ($wrapper.prop("scrollHeight") > $window.height())
            $wrapper.css("height", "auto");
          else $wrapper.css("height", "100vh");
        }, 250);
      })
      .triggerHandler("resize.flexbox-fix");
  }

  var $nav = $header.children("nav"),
    $nav_li = $nav.find("li");

  if ($nav_li.length % 2 == 0) {
    $nav.addClass("use-middle");
    $nav_li.eq($nav_li.length / 2).addClass("is-middle");
  }

  var delay = 325,
    locked = false;

  $main._show = function (id, initial) {
    var $article = $main_articles.filter("#" + id);

    if ($article.length == 0) return;

    if (locked || (typeof initial != "undefined" && initial === true)) {
      $body.addClass("is-switching");

      $body.addClass("is-article-visible");

      $main_articles.removeClass("active");

      $header.hide();
      $footer.hide();

      $main.show();
      $article.show();

      $article.addClass("active");

      locked = false;

      setTimeout(
        function () {
          $body.removeClass("is-switching");
        },
        initial ? 1000 : 0
      );

      return;
    }

    locked = true;

    if ($body.hasClass("is-article-visible")) {
      var $currentArticle = $main_articles.filter(".active");

      $currentArticle.removeClass("active");

      setTimeout(function () {
        $currentArticle.hide();

        $article.show();

        setTimeout(function () {
          $article.addClass("active");

          $window.scrollTop(0).triggerHandler("resize.flexbox-fix");

          setTimeout(function () {
            locked = false;
          }, delay);
        }, 25);
      }, delay);
    } else {
      $body.addClass("is-article-visible");

      setTimeout(function () {
        $header.hide();
        $footer.hide();

        $main.show();
        $article.show();

        setTimeout(function () {
          $article.addClass("active");

          $window.scrollTop(0).triggerHandler("resize.flexbox-fix");

          setTimeout(function () {
            locked = false;
          }, delay);
        }, 25);
      }, delay);
    }
  };

  $main._hide = function (addState) {
    var $article = $main_articles.filter(".active");

    if (!$body.hasClass("is-article-visible")) return;

    if (typeof addState != "undefined" && addState === true)
      history.pushState(null, null, "#");

    if (locked) {
      $body.addClass("is-switching");

      $article.removeClass("active");

      $article.hide();
      $main.hide();

      $footer.show();
      $header.show();

      $body.removeClass("is-article-visible");

      locked = false;

      $body.removeClass("is-switching");

      $window.scrollTop(0).triggerHandler("resize.flexbox-fix");

      return;
    }

    locked = true;

    $article.removeClass("active");

    setTimeout(function () {
      $article.hide();
      $main.hide();

      $footer.show();
      $header.show();

      setTimeout(function () {
        $body.removeClass("is-article-visible");

        $window.scrollTop(0).triggerHandler("resize.flexbox-fix");

        setTimeout(function () {
          locked = false;
        }, delay);
      }, 25);
    }, delay);
  };

  $main_articles.each(function () {
    var $this = $(this);

    $('<div class="close">Close</div>')
      .appendTo($this)
      .on("click", function () {
        location.hash = "";
      });

    $this.on("click", function (event) {
      event.stopPropagation();
    });
  });

  $body.on("click", function (event) {
    if ($body.hasClass("is-article-visible")) $main._hide(true);
  });

  $window.on("keyup", function (event) {
    switch (event.keyCode) {
      case 27:
        if ($body.hasClass("is-article-visible")) $main._hide(true);

        break;

      default:
        break;
    }
  });

  $window.on("hashchange", function (event) {
    if (location.hash == "" || location.hash == "#") {
      event.preventDefault();
      event.stopPropagation();

      $main._hide();
    } else if ($main_articles.filter(location.hash).length > 0) {
      event.preventDefault();
      event.stopPropagation();

      $main._show(location.hash.substr(1));
    }
  });

  if ("scrollRestoration" in history) history.scrollRestoration = "manual";
  else {
    var oldScrollPos = 0,
      scrollPos = 0,
      $htmlbody = $("html,body");

    $window
      .on("scroll", function () {
        oldScrollPos = scrollPos;
        scrollPos = $htmlbody.scrollTop();
      })
      .on("hashchange", function () {
        $window.scrollTop(oldScrollPos);
      });
  }

  $main.hide();
  $main_articles.hide();

  if (location.hash != "" && location.hash != "#")
    $window.on("load", function () {
      $main._show(location.hash.substr(1), true);
    });
  function initRotatingReview() {
    var $container = $(".rotating-review");
    var $items = $container.find(".review-item");
    if ($items.length === 0) return;
    var index = 0;

    function setContainerHeight(i) {
      var $it = $items.eq(i);
      if ($it.length) {
        $container.height($it.outerHeight(true));
      }
    }

    function show(i) {
      $items.removeClass("active");
      var $next = $items.eq(i).addClass("active");
      setContainerHeight(i);
    }

    // Initialize
    show(index);

    if ($items.length <= 1) return;
    setInterval(function () {
      index = (index + 1) % $items.length;
      show(index);
    }, 5000);
  }
  $(function () {
    initRotatingReview();
  });
  function s(r) {
    if (r || r === 0) {
      var n = Math.max(0, Math.min(5, Math.round(r)));
      return "★★★★★".slice(0, n) + "☆☆☆☆☆".slice(0, 5 - n);
    }
    return "★★★★★";
  }
  function p(e) {
    if (!e) return;
    if (typeof e.rating === "number") {
      $(".rating-number").text(e.rating.toFixed(1));
      $(".stars").text(s(e.rating));
      $(".rating-inline").attr(
        "aria-label",
        "Gesamtbewertung " +
          e.rating.toFixed(1) +
          " von 5 basierend auf " +
          (e.total || 0) +
          " Bewertungen"
      );
    }
    if (typeof e.total === "number") {
      $(".review-count").text(e.total + " Bewertungen");
    }
  }
  function q(e) {
    if (!e || !Array.isArray(e.reviews) || !e.reviews.length) return;
    var c = $(".rotating-review");
    if (!c.length) return;
    c.empty();
    e.reviews.slice(0, 5).forEach(function (r, i) {
      var t = $('<div class="review-item">');
      if (i === 0) t.addClass("active");
      $('<span class="review-stars">').text(s(r.rating)).appendTo(t);
      $('<span class="review-text">')
        .text('"' + (r.text || "").trim() + '"')
        .appendTo(t);
      if (r.author)
        $('<span class="review-author">')
          .text("– " + r.author)
          .appendTo(t);
      c.append(t);
    });
    initRotatingReview();
  }
  function f() {
    try {
      var u = "/assets/data/reviews.json?ts=" + Date.now();
      fetch(u, { cache: "no-store" })
        .then(function (r) {
          return r.ok ? r.json() : null;
        })
        .then(function (d) {
          if (!d) return;
          p(d);
          q(d);
        })
        .catch(function () {});
    } catch (e) {}
  }
  $(function () {
    f();
  });
})(jQuery);
